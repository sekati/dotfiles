#!/bin/sh
# Sekati: Gource Git Repo Viz Video Exporter
# @author jason m horwitz | sekati.com
# Copyright (C) 2012 jason m horwitz, Sekat LLC. All Rights Reserved.
# @see http://code.google.com/p/gource/wiki/Controls
# @see http://code.google.com/p/gource/wiki/Videos
# @see https://github.com/acaudwell/Gource

# meta
NAME="Gource Code Visualizer"
VERSION="1.0.1"

# bins
GOURCE="$(which gource)"
FFMPEG="$(which ffmpeg)"

# switch to script dir
SCRIPT="$(basename "$(test -L "$0" && readlink "$0" || echo "$0")")"
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd $DIR
echo "$DIR/$SCRIPT"

# PREFERENCES
TITLE="" # "--title Code Visualization"
ASSETS="~/Pictures/gource/"
TIMESCALE=2 # default 1
SKIPSECONDS=1 # default 3
SECONDSPERDAY=5 # default 10
CAMERAMODE="overview" # "track" - tracks active user & "overview" - keeps entire repo in view
SIZE="1280x720" # "720Ã—480"
MULTIPLIER="1.0"
INTENSITY="1.0"
OPTS="$TITLE --logo ${ASSETS}logo.png --user-image-dir ${ASSETS} --default-user-image ${ASSETS}Jason Horwitz.jpg --stop-at-end --auto-skip-seconds $SKIPSECONDS --time-scale $TIMESCALE --camera-mode $CAMERAMODE --seconds-per-day $SECONDSPERDAY --bloom-multiplier $MULTIPLIER --bloom-intensity $INTENSITY"
OUTPUT="~/Desktop/gource.mp4"

printHeader(){
        echo "$NAME v$VERSION"
}

printUsage() {
        printHeader
        echo "Usage: $0 { play | export }"
}

case $1 in
        export)
				printHeader
				echo "Exporting Gource Visualization Video ..."
				$GOURCE $OPTS -$SIZE -o - | $FFMPEG -y -r 60 -f image2pipe -vcodec ppm -i - -vcodec libx264 -preset ultrafast -crf 1 -threads 0 -bf 0 $OUTPUT
                ;;

                play|show|display)
                printHeader
				echo "Playing Gource Visualization Video ..."
                $GOURCE $OPTS
				;;

		        *|?)
		        printUsage
		        exit 1  
		        ;;
esac
exit 0
